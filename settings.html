<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è®¾ç½® - åŸºé‡‘ç®¡ç†åŠ©æ‰‹</title>

  <!-- CSS æ ·å¼ -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/responsive.css">

  <style>
    /* è®¾ç½®é¡µé¢ç‰¹å®šæ ·å¼ */
    .settings-section {
      background-color: var(--bg-card);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-md);
      overflow: hidden;
    }

    .settings-section-title {
      padding: var(--spacing-md);
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-light);
    }

    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .settings-item:last-child {
      border-bottom: none;
    }

    .settings-item:active {
      background-color: var(--bg-secondary);
    }

    .settings-item-label {
      font-size: var(--font-size-md);
    }

    .settings-item-icon {
      margin-right: var(--spacing-sm);
      font-size: var(--font-size-lg);
    }

    .settings-item-value {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
    }

    .settings-item-arrow {
      margin-left: var(--spacing-sm);
      color: var(--text-hint);
    }

    .switch {
      position: relative;
      width: 50px;
      height: 28px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border-color);
      transition: 0.3s;
      border-radius: 28px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary-color);
    }

    input:checked + .slider:before {
      transform: translateX(22px);
    }

    .storage-info {
      padding: var(--spacing-md);
      background-color: var(--bg-secondary);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-md);
    }

    .storage-info-item {
      display: flex;
      justify-content: space-between;
      font-size: var(--font-size-sm);
      padding: var(--spacing-xs) 0;
    }

    .storage-info-label {
      color: var(--text-secondary);
    }

    .storage-info-value {
      font-weight: var(--font-weight-medium);
    }

    .danger-zone {
      border: 1px solid var(--danger-color);
    }

    .danger-zone .settings-item-label {
      color: var(--danger-color);
    }

    .version-info {
      text-align: center;
      padding: var(--spacing-lg);
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
    }

    .file-input {
      display: none;
    }

    .about-card {
      text-align: center;
      padding: var(--spacing-xl);
    }

    .app-icon {
      font-size: 64px;
      margin-bottom: var(--spacing-md);
    }

    .app-name {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--spacing-xs);
    }

    .app-version {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin-bottom: var(--spacing-lg);
    }
  </style>
</head>
<body>
  <!-- å¤´éƒ¨ -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <h1 class="header-title">è®¾ç½®</h1>
        <div style="width: 36px;"></div>
      </div>
    </div>
  </header>

  <!-- ä¸»å†…å®¹ -->
  <main class="container" style="padding-bottom: 80px;">
    <!-- æ•°æ®ç®¡ç† -->
    <div class="settings-section">
      <div class="settings-section-title">æ•°æ®ç®¡ç†</div>
      <div class="settings-item" onclick="exportData()">
        <span class="settings-item-icon">ğŸ“¤</span>
        <span class="settings-item-label">å¯¼å‡ºæ•°æ®</span>
        <span class="settings-item-arrow">â€º</span>
      </div>
      <div class="settings-item" onclick="document.getElementById('importInput').click()">
        <span class="settings-item-icon">ğŸ“¥</span>
        <span class="settings-item-label">å¯¼å…¥æ•°æ®</span>
        <span class="settings-item-arrow">â€º</span>
      </div>
      <input type="file" id="importInput" class="file-input" accept=".json" onchange="importData(event)">
      <div class="settings-item" onclick="clearCache()">
        <span class="settings-item-icon">ğŸ§¹</span>
        <span class="settings-item-label">æ¸…é™¤ç¼“å­˜</span>
        <span class="settings-item-value" id="cacheSize">--</span>
      </div>
    </div>

    <!-- å¤–è§‚è®¾ç½® -->
    <div class="settings-section">
      <div class="settings-section-title">å¤–è§‚è®¾ç½®</div>
      <div class="settings-item">
        <span class="settings-item-icon">ğŸ¨</span>
        <span class="settings-item-label">æ·±è‰²æ¨¡å¼</span>
        <label class="switch">
          <input type="checkbox" id="darkModeToggle" onchange="toggleTheme()">
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <!-- å­˜å‚¨ä¿¡æ¯ -->
    <div class="storage-info">
      <div class="storage-info-item">
        <span class="storage-info-label">æŒä»“æ•°é‡</span>
        <span class="storage-info-value" id="holdingCount">0</span>
      </div>
      <div class="storage-info-item">
        <span class="storage-info-label">äº¤æ˜“è®°å½•</span>
        <span class="storage-info-value" id="transactionCount">0</span>
      </div>
      <div class="storage-info-item">
        <span class="storage-info-label">å­˜å‚¨ç©ºé—´</span>
        <span class="storage-info-value" id="storageSize">--</span>
      </div>
    </div>

    <!-- å±é™©åŒºåŸŸ -->
    <div class="settings-section danger-zone">
      <div class="settings-section-title" style="color: var(--danger-color);">å±é™©åŒºåŸŸ</div>
      <div class="settings-item" onclick="clearAllData()">
        <span class="settings-item-icon">âš ï¸</span>
        <span class="settings-item-label">æ¸…ç©ºæ‰€æœ‰æ•°æ®</span>
        <span class="settings-item-arrow">â€º</span>
      </div>
    </div>

    <!-- å…³äº -->
    <div class="settings-section">
      <div class="about-card">
        <div class="app-icon">ğŸ“Š</div>
        <div class="app-name">åŸºé‡‘ç®¡ç†åŠ©æ‰‹</div>
        <div class="app-version">ç‰ˆæœ¬ 1.0.0</div>
        <p class="text-secondary text-sm">ä¸€ä¸ªç®€æ´çš„åŸºé‡‘æŒä»“ç®¡ç†å·¥å…·</p>
        <p class="text-secondary text-xs mt-2">æ•°æ®æ¥æº: ä¸œæ–¹è´¢å¯Œç½‘</p>
      </div>
    </div>

    <div class="version-info">
      ä»…ä¾›ä¸ªäººä½¿ç”¨ï¼Œä¸æ„æˆæŠ•èµ„å»ºè®®
    </div>
  </main>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <nav class="bottom-nav">
    <a href="index.html" class="bottom-nav-item">
      <span class="bottom-nav-item-icon">ğŸ“Š</span>
      <span>æŒä»“</span>
    </a>
    <a href="transactions.html" class="bottom-nav-item">
      <span class="bottom-nav-item-icon">ğŸ“</span>
      <span>äº¤æ˜“</span>
    </a>
    <a href="settings.html" class="bottom-nav-item active">
      <span class="bottom-nav-item-icon">âš™ï¸</span>
      <span>è®¾ç½®</span>
    </a>
  </nav>

  <!-- JavaScript -->
  <script src="js/storage.js"></script>
  <script src="js/utils.js"></script>
  <script>
    /**
     * åˆå§‹åŒ–é¡µé¢
     */
    function initPage() {
      updateStorageInfo();
      loadTheme();
    }

    /**
     * æ›´æ–°å­˜å‚¨ä¿¡æ¯
     */
    function updateStorageInfo() {
      const info = Storage.getStorageInfo();

      if (info) {
        document.getElementById('holdingCount').textContent = info.count.holdings;
        document.getElementById('transactionCount').textContent = info.count.transactions;

        // è®¡ç®—ç¼“å­˜å¤§å°
        const cacheSize = info.items.fundCache || 0;
        document.getElementById('cacheSize').textContent = formatSize(cacheSize);

        // è®¡ç®—æ€»å¤§å°
        const totalSize = info.total;
        document.getElementById('storageSize').textContent = formatSize(totalSize);
      }
    }

    /**
     * æ ¼å¼åŒ–å¤§å°
     */
    function formatSize(bytes) {
      if (bytes === 0) return '0 B';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    /**
     * å¯¼å‡ºæ•°æ®
     */
    function exportData() {
      const data = Storage.exportData();

      if (!data) {
        Utils.toast('å¯¼å‡ºå¤±è´¥');
        return;
      }

      const filename = `åŸºé‡‘æ•°æ®_${new Date().toISOString().split('T')[0]}.json`;
      Utils.downloadFile(data, filename, 'application/json');
      Utils.toast('å¯¼å‡ºæˆåŠŸ');
    }

    /**
     * å¯¼å…¥æ•°æ®
     */
    function importData(event) {
      const file = event.target.files[0];

      if (!file) return;

      Utils.readFile(file).then(content => {
        const success = Storage.importData(content);

        if (success) {
          Utils.toast('å¯¼å…¥æˆåŠŸ');
          updateStorageInfo();
        } else {
          Utils.toast('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
        }

        // æ¸…ç©º inputï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
        event.target.value = '';
      }).catch(error => {
        console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', error);
        Utils.toast('è¯»å–æ–‡ä»¶å¤±è´¥');
      });
    }

    /**
     * æ¸…é™¤ç¼“å­˜
     */
    function clearCache() {
      Storage.clearExpiredCache();
      Utils.toast('ç¼“å­˜å·²æ¸…é™¤');
      updateStorageInfo();
    }

    /**
     * æ¸…ç©ºæ‰€æœ‰æ•°æ®
     */
    async function clearAllData() {
      const confirmed = await Utils.confirm(
        'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰æŒä»“å’Œäº¤æ˜“è®°å½•ï¼Œä¸”ä¸å¯æ¢å¤ï¼',
        'ç¡®è®¤æ¸…ç©º'
      );

      if (confirmed) {
        Storage.clearAll();
        Utils.toast('æ•°æ®å·²æ¸…ç©º');
        updateStorageInfo();
      }
    }

    /**
     * åŠ è½½ä¸»é¢˜è®¾ç½®
     */
    function loadTheme() {
      const theme = Storage.getSetting('theme') || 'light';
      document.getElementById('darkModeToggle').checked = theme === 'dark';
    }

    /**
     * åˆ‡æ¢ä¸»é¢˜
     */
    function toggleTheme() {
      const isDark = document.getElementById('darkModeToggle').checked;
      const theme = isDark ? 'dark' : 'light';

      document.documentElement.setAttribute('data-theme', theme);
      Storage.setSetting('theme', theme);

      Utils.toast(isDark ? 'å·²åˆ‡æ¢åˆ°æ·±è‰²æ¨¡å¼' : 'å·²åˆ‡æ¢åˆ°æµ…è‰²æ¨¡å¼');
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>
