<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>åŸºé‡‘è¯¦æƒ… - åŸºé‡‘ç®¡ç†åŠ©æ‰‹</title>

  <!-- CSS æ ·å¼ -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/responsive.css">

  <style>
    /* åŸºé‡‘è¯¦æƒ…é¡µé¢ç‰¹å®šæ ·å¼ */
    .fund-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      padding: var(--spacing-lg) var(--spacing-md);
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
    }

    .fund-name {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--spacing-xs);
    }

    .fund-code {
      font-size: var(--font-size-sm);
      opacity: 0.9;
    }

    .fund-type {
      display: inline-block;
      margin-top: var(--spacing-sm);
      padding: 4px var(--spacing-sm);
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
    }

    .profit-summary {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      margin: var(--spacing-md) 0;
    }

    .profit-item {
      text-align: center;
      padding: var(--spacing-md);
      background-color: var(--bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
    }

    .profit-label {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xs);
    }

    .profit-value {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
    }

    .holding-info-card {
      background-color: var(--bg-card);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: var(--spacing-sm) 0;
      border-bottom: 1px solid var(--border-light);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
    }

    .info-value {
      font-weight: var(--font-weight-medium);
    }

    .action-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--spacing-sm);
      padding: var(--spacing-md);
    }

    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: var(--spacing-md);
      background-color: var(--bg-card);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .action-btn:active {
      background-color: var(--bg-secondary);
    }

    .action-btn-icon {
      font-size: 24px;
      margin-bottom: 4px;
    }

    .action-btn-text {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
    }

    .transaction-list {
      padding: var(--spacing-md);
    }

    .transaction-item {
      padding: var(--spacing-md);
      background-color: var(--bg-card);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-sm);
    }

    .transaction-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--spacing-xs);
    }

    .transaction-type {
      font-weight: var(--font-weight-medium);
    }

    .transaction-date {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
    }

    .transaction-details {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }

    .empty-transactions {
      text-align: center;
      padding: var(--spacing-xl) var(--spacing-md);
      color: var(--text-secondary);
    }

    .delete-btn {
      position: fixed;
      bottom: 80px;
      left: var(--spacing-md);
      padding: var(--spacing-sm) var(--spacing-md);
      background-color: var(--danger-color);
      color: white;
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      box-shadow: var(--shadow-md);
      cursor: pointer;
    }

    .chart-container {
      height: 200px;
      margin: var(--spacing-md);
      background-color: var(--bg-card);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <!-- å¤´éƒ¨ -->
  <header class="header" style="background: transparent; box-shadow: none; position: absolute; width: 100%;">
    <div class="container">
      <div class="header-content">
        <button class="btn btn-icon" onclick="history.back()" style="color: white;" aria-label="è¿”å›">
          â†
        </button>
        <h1 class="header-title" style="color: white;">åŸºé‡‘è¯¦æƒ…</h1>
        <div style="width: 36px;"></div>
      </div>
    </div>
  </header>

  <!-- ä¸»å†…å®¹ -->
  <main style="padding-top: 60px; padding-bottom: 100px;">
    <!-- åŸºé‡‘å¤´éƒ¨ä¿¡æ¯ -->
    <div class="fund-header" id="fundHeader">
      <div class="fund-name" id="fundName">--</div>
      <div class="fund-code" id="fundCode">--</div>
      <div class="fund-type" id="fundType">--</div>
    </div>

    <!-- æ”¶ç›Šæ¦‚è§ˆ -->
    <div class="profit-summary">
      <div class="profit-item">
        <div class="profit-label">ç´¯è®¡æ”¶ç›Š</div>
        <div class="profit-value" id="totalProfit">--</div>
      </div>
      <div class="profit-item">
        <div class="profit-label">ä»Šæ—¥æ”¶ç›Š</div>
        <div class="profit-value" id="todayProfit">--</div>
      </div>
    </div>

    <!-- æŒä»“ä¿¡æ¯ -->
    <div class="container">
      <div class="holding-info-card">
        <div class="card-title" style="margin-bottom: var(--spacing-md);">æŒä»“ä¿¡æ¯</div>
        <div class="info-row">
          <span class="info-label">æŒæœ‰ä»½é¢</span>
          <span class="info-value" id="holdingShares">--</span>
        </div>
        <div class="info-row">
          <span class="info-label">æˆæœ¬å•ä»·</span>
          <span class="info-value" id="costPrice">--</span>
        </div>
        <div class="info-row">
          <span class="info-label">æˆæœ¬é‡‘é¢</span>
          <span class="info-value" id="costAmount">--</span>
        </div>
        <div class="info-row">
          <span class="info-label">æœ€æ–°å‡€å€¼</span>
          <span class="info-value" id="latestNav">--</span>
        </div>
        <div class="info-row">
          <span class="info-label">å½“å‰å¸‚å€¼</span>
          <span class="info-value" id="currentValue">--</span>
        </div>
        <div class="info-row">
          <span class="info-label">æŒæœ‰å¤©æ•°</span>
          <span class="info-value" id="holdingDays">--</span>
        </div>
      </div>

      <!-- æ”¶ç›Šèµ°åŠ¿å›¾ -->
      <div class="card-title">æ”¶ç›Šèµ°åŠ¿</div>
      <div class="chart-container">
        <div style="text-align: center;">
          <div style="font-size: 48px; opacity: 0.5;">ğŸ“ˆ</div>
          <div class="text-sm mt-2">å›¾è¡¨åŠŸèƒ½å¼€å‘ä¸­</div>
        </div>
      </div>

      <!-- äº¤æ˜“è®°å½• -->
      <div class="card-title">äº¤æ˜“è®°å½•</div>
      <div id="transactionList">
        <!-- äº¤æ˜“åˆ—è¡¨å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </main>

  <!-- åˆ é™¤æŒ‰é’® -->
  <div class="delete-btn" id="deleteBtn">åˆ é™¤æŒä»“</div>

  <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
  <div class="action-buttons">
    <div class="action-btn" id="addBtn">
      <span class="action-btn-icon">â•</span>
      <span class="action-btn-text">åŠ ä»“</span>
    </div>
    <div class="action-btn" id="reduceBtn">
      <span class="action-btn-icon">â–</span>
      <span class="action-btn-text">å‡ä»“</span>
    </div>
    <div class="action-btn" onclick="window.open('https://fund.eastmoney.com/' + currentFundCode + '.html', '_blank')">
      <span class="action-btn-icon">ğŸ“Š</span>
      <span class="action-btn-text">è¯¦æƒ…</span>
    </div>
    <div class="action-btn" id="refreshBtn">
      <span class="action-btn-icon">ğŸ”„</span>
      <span class="action-btn-text">åˆ·æ–°</span>
    </div>
  </div>

  <!-- äº¤æ˜“å¼¹çª— -->
  <div id="transactionModal" style="display: none;">
    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100;"></div>
    <div style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-card); border-radius: var(--radius-lg) var(--radius-lg) 0 0; padding: var(--spacing-lg); z-index: 101; max-height: 80vh; overflow-y: auto;">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-bold" id="modalTitle">äº¤æ˜“</h2>
        <button class="btn btn-icon" id="closeModal">âœ•</button>
      </div>
      <form id="transactionForm">
        <div class="form-group">
          <label class="form-label">ä»½é¢</label>
          <input type="number" class="form-input" id="transShares" placeholder="è¯·è¾“å…¥ä»½é¢" step="0.01" min="0.01" required>
        </div>
        <div class="form-group">
          <label class="form-label">ç¡®è®¤å‡€å€¼</label>
          <input type="number" class="form-input" id="transPrice" placeholder="è¯·è¾“å…¥ç¡®è®¤å‡€å€¼" step="0.0001" min="0.0001" required>
        </div>
        <div class="form-group">
          <label class="form-label">äº¤æ˜“é‡‘é¢</label>
          <input type="number" class="form-input" id="transAmount" placeholder="è‡ªåŠ¨è®¡ç®—" readonly>
        </div>
        <div class="form-group">
          <label class="form-label">äº¤æ˜“æ—¥æœŸ</label>
          <input type="date" class="form-input" id="transDate" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">ç¡®è®¤</button>
      </form>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="js/storage.js"></script>
  <script src="js/fund-api.js"></script>
  <script src="js/calculator.js"></script>
  <script src="js/utils.js"></script>
  <script>
    // å½“å‰åŸºé‡‘
    let currentFund = null;
    let currentFundCode = '';
    let transactionType = 'buy';

    // ä»URLè·å–åŸºé‡‘ID
    const urlParams = Utils.parseUrlParams();
    const holdingId = urlParams.id || sessionStorage.getItem('currentHoldingId');

    /**
     * åˆå§‹åŒ–é¡µé¢
     */
    async function initPage() {
      if (!holdingId) {
        Utils.toast('å‚æ•°é”™è¯¯');
        history.back();
        return;
      }

      // åŠ è½½æŒä»“æ•°æ®
      const holdings = Storage.getHoldings();
      currentFund = holdings.find(h => h.id === holdingId);

      if (!currentFund) {
        Utils.toast('æœªæ‰¾åˆ°è¯¥æŒä»“');
        history.back();
        return;
      }

      currentFundCode = currentFund.code;

      // æ¸²æŸ“åŸºé‡‘ä¿¡æ¯
      renderFundInfo();

      // æ¸²æŸ“äº¤æ˜“è®°å½•
      renderTransactions();

      // åˆ·æ–°å‡€å€¼æ•°æ®
      await refreshNetValue();
    }

    /**
     * æ¸²æŸ“åŸºé‡‘ä¿¡æ¯
     */
    function renderFundInfo() {
      document.getElementById('fundName').textContent = currentFund.name;
      document.getElementById('fundCode').textContent = currentFund.code;
      document.getElementById('fundType').textContent = currentFund.type || 'åŸºé‡‘';

      // è®¡ç®—æ”¶ç›Š
      const profit = Calculator.calculateProfit(currentFund, currentFund.lastNav || currentFund.costPrice);
      const profitFormat = Calculator.formatProfit(profit.profit, profit.profitRate);

      // ç´¯è®¡æ”¶ç›Š
      document.getElementById('totalProfit').textContent = profitFormat.amountText;
      document.getElementById('totalProfit').className = 'profit-value ' + profitFormat.className;

      // ä»Šæ—¥æ”¶ç›Š
      const dayProfit = Calculator.calculateDayProfit(currentFund, currentFund.dayChange || 0);
      const dayProfitFormat = Calculator.formatProfit(dayProfit, currentFund.dayChange || 0);
      document.getElementById('todayProfit').textContent = dayProfitFormat.amountText;
      document.getElementById('todayProfit').className = 'profit-value ' + dayProfitFormat.className;

      // æŒä»“ä¿¡æ¯
      document.getElementById('holdingShares').textContent = currentFund.shares.toFixed(2) + ' ä»½';
      document.getElementById('costPrice').textContent = 'Â¥' + currentFund.costPrice.toFixed(4);
      document.getElementById('costAmount').textContent = 'Â¥' + profit.costAmount.toFixed(2);
      document.getElementById('latestNav').textContent = 'Â¥' + (currentFund.lastNav || currentFund.costPrice).toFixed(4);
      document.getElementById('currentValue').textContent = 'Â¥' + profit.currentAmount.toFixed(2);

      // æŒæœ‰å¤©æ•°
      const holdingDays = Calculator.calculateHoldingDays(currentFund.addDate);
      document.getElementById('holdingDays').textContent = holdingDays + ' å¤©';
    }

    /**
     * æ¸²æŸ“äº¤æ˜“è®°å½•
     */
    function renderTransactions() {
      const listEl = document.getElementById('transactionList');
      const transactions = Storage.getTransactions().filter(t => t.fundCode === currentFund.code);

      if (transactions.length === 0) {
        listEl.innerHTML = `
          <div class="empty-transactions">
            <p>æš‚æ— äº¤æ˜“è®°å½•</p>
          </div>
        `;
        return;
      }

      listEl.innerHTML = transactions.map(t => {
        const typeName = Utils.getTransactionTypeName(t.type);
        const typeClass = Utils.getTransactionTypeClass(t.type);

        return `
          <div class="transaction-item">
            <div class="transaction-header">
              <span class="transaction-type ${typeClass}">${typeName}</span>
              <span class="transaction-date">${t.date}</span>
            </div>
            <div class="transaction-details">
              ${t.shares.toFixed(2)} ä»½ @ Â¥${t.price.toFixed(4)} Â· é‡‘é¢ Â¥${t.amount.toFixed(2)}
            </div>
          </div>
        `;
      }).join('');
    }

    /**
     * åˆ·æ–°å‡€å€¼
     */
    async function refreshNetValue() {
      try {
        const estimate = await FundAPI.getFundEstimate(currentFund.code);

        if (estimate) {
          currentFund.lastNav = estimate.netWorth;
          currentFund.dayChange = estimate.dayGrowth;
          currentFund.estimateTime = estimate.time;

          // æ›´æ–°æŒä»“
          Storage.updateHolding(currentFund.id, {
            lastNav: currentFund.lastNav,
            dayChange: currentFund.dayChange
          });

          // é‡æ–°æ¸²æŸ“
          renderFundInfo();
          Utils.toast('æ•°æ®å·²æ›´æ–°');
        }
      } catch (error) {
        console.error('åˆ·æ–°å‡€å€¼å¤±è´¥:', error);
      }
    }

    /**
     * æ˜¾ç¤ºäº¤æ˜“å¼¹çª—
     */
    function showTransactionModal(type) {
      transactionType = type;
      const title = type === 'buy' ? 'åŠ ä»“' : 'å‡ä»“';
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('transShares').value = '';
      document.getElementById('transPrice').value = currentFund.lastNav || currentFund.costPrice;
      document.getElementById('transAmount').value = '';
      document.getElementById('transDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('transactionModal').style.display = 'block';
    }

    /**
     * å…³é—­äº¤æ˜“å¼¹çª—
     */
    function closeTransactionModal() {
      document.getElementById('transactionModal').style.display = 'none';
    }

    /**
     * è®¡ç®—äº¤æ˜“é‡‘é¢
     */
    function calculateTransAmount() {
      const shares = parseFloat(document.getElementById('transShares').value) || 0;
      const price = parseFloat(document.getElementById('transPrice').value) || 0;
      const amount = shares * price;
      document.getElementById('transAmount').value = amount > 0 ? amount.toFixed(2) : '';
    }

    /**
     * æäº¤äº¤æ˜“
     */
    function submitTransaction(e) {
      e.preventDefault();

      const shares = parseFloat(document.getElementById('transShares').value);
      const price = parseFloat(document.getElementById('transPrice').value);
      const date = document.getElementById('transDate').value;

      if (!Utils.isValidShares(shares)) {
        Utils.toast('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»½é¢');
        return;
      }

      if (!Utils.isValidPrice(price)) {
        Utils.toast('è¯·è¾“å…¥æœ‰æ•ˆçš„å‡€å€¼');
        return;
      }

      if (transactionType === 'sell' && shares > currentFund.shares) {
        Utils.toast('å–å‡ºä»½é¢ä¸èƒ½è¶…è¿‡æŒæœ‰ä»½é¢');
        return;
      }

      // è®¡ç®—äº¤æ˜“åçš„æŒä»“
      const transaction = {
        fundCode: currentFund.code,
        fundName: currentFund.name,
        type: transactionType,
        shares: shares,
        price: price,
        amount: shares * price,
        date: date
      };

      // æ·»åŠ äº¤æ˜“è®°å½•
      Storage.addTransaction(transaction);

      // æ›´æ–°æŒä»“
      const afterTrans = Calculator.calculateAfterTransaction(currentFund, transaction);

      if (afterTrans.shares === 0) {
        // å…¨éƒ¨å–å‡ºï¼Œåˆ é™¤æŒä»“
        Storage.deleteHolding(currentFund.id);
        Utils.toast('äº¤æ˜“æˆåŠŸï¼ŒæŒä»“å·²æ¸…ç©º');
        setTimeout(() => {
          location.href = 'index.html';
        }, 1000);
      } else {
        Storage.updateHolding(currentFund.id, afterTrans);
        currentFund.shares = afterTrans.shares;
        currentFund.costPrice = afterTrans.costPrice;

        Utils.toast('äº¤æ˜“æˆåŠŸ');
        closeTransactionModal();
        renderFundInfo();
        renderTransactions();
      }
    }

    /**
     * åˆ é™¤æŒä»“
     */
    async function deleteHolding() {
      const confirmed = await Utils.confirm(`ç¡®å®šè¦åˆ é™¤ "${currentFund.name}" çš„æŒä»“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`);
      if (confirmed) {
        Storage.deleteHolding(currentFund.id);
        Utils.toast('å·²åˆ é™¤');
        setTimeout(() => {
          location.href = 'index.html';
        }, 500);
      }
    }

    // äº‹ä»¶ç»‘å®š
    document.getElementById('addBtn').addEventListener('click', () => showTransactionModal('buy'));
    document.getElementById('reduceBtn').addEventListener('click', () => showTransactionModal('sell'));
    document.getElementById('refreshBtn').addEventListener('click', refreshNetValue);
    document.getElementById('closeModal').addEventListener('click', closeTransactionModal);
    document.getElementById('deleteBtn').addEventListener('click', deleteHolding);

    document.getElementById('transShares').addEventListener('input', calculateTransAmount);
    document.getElementById('transPrice').addEventListener('input', calculateTransAmount);
    document.getElementById('transactionForm').addEventListener('submit', submitTransaction);

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>
