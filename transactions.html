<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>äº¤æ˜“è®°å½• - åŸºé‡‘ç®¡ç†åŠ©æ‰‹</title>

  <!-- CSS æ ·å¼ -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/responsive.css">

  <style>
    /* äº¤æ˜“è®°å½•é¡µé¢ç‰¹å®šæ ·å¼ */
    .filter-tabs {
      display: flex;
      background-color: var(--bg-card);
      border-bottom: 1px solid var(--border-light);
      overflow-x: auto;
      white-space: nowrap;
    }

    .filter-tab {
      flex: 1;
      padding: var(--spacing-md);
      text-align: center;
      font-size: var(--font-size-md);
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .filter-tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      font-weight: var(--font-weight-medium);
    }

    .transaction-list {
      padding: var(--spacing-md);
    }

    .transaction-item {
      background-color: var(--bg-card);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-sm);
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .transaction-item:active {
      background-color: var(--bg-secondary);
    }

    .transaction-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }

    .transaction-fund {
      font-size: var(--font-size-md);
      font-weight: var(--font-weight-medium);
    }

    .transaction-type-badge {
      display: inline-block;
      padding: 2px var(--spacing-sm);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
    }

    .transaction-type-badge.buy {
      background-color: rgba(244, 67, 54, 0.1);
      color: var(--danger-color);
    }

    .transaction-type-badge.sell {
      background-color: rgba(76, 175, 80, 0.1);
      color: var(--success-color);
    }

    .transaction-type-badge.convert {
      background-color: rgba(33, 150, 243, 0.1);
      color: var(--primary-color);
    }

    .transaction-details {
      display: flex;
      justify-content: space-between;
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }

    .transaction-shares {
      flex: 1;
    }

    .transaction-amount {
      font-weight: var(--font-weight-medium);
      color: var(--text-primary);
    }

    .transaction-date {
      font-size: var(--font-size-xs);
      color: var(--text-hint);
      margin-top: var(--spacing-xs);
    }

    .empty-state {
      text-align: center;
      padding: var(--spacing-xl) var(--spacing-md);
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: var(--spacing-md);
      opacity: 0.5;
    }

    .stats-bar {
      display: flex;
      padding: var(--spacing-md);
      background-color: var(--bg-secondary);
      border-bottom: 1px solid var(--border-light);
    }

    .stat-item {
      flex: 1;
      text-align: center;
    }

    .stat-label {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: var(--font-size-md);
      font-weight: var(--font-weight-bold);
      color: var(--primary-color);
    }

    .date-group {
      margin-bottom: var(--spacing-md);
    }

    .date-header {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      padding: var(--spacing-sm) var(--spacing-md);
      background-color: var(--bg-secondary);
    }
  </style>
</head>
<body>
  <!-- å¤´éƒ¨ -->
  <header class="header">
    <div class="container">
      <div class="header-content">
        <h1 class="header-title">äº¤æ˜“è®°å½•</h1>
        <button class="btn btn-icon" id="exportBtn" aria-label="å¯¼å‡º">
          ğŸ“¤
        </button>
      </div>
    </div>
  </header>

  <!-- ç­›é€‰æ ‡ç­¾ -->
  <div class="filter-tabs">
    <div class="filter-tab active" data-filter="all">å…¨éƒ¨</div>
    <div class="filter-tab" data-filter="buy">ä¹°å…¥</div>
    <div class="filter-tab" data-filter="sell">å–å‡º</div>
    <div class="filter-tab" data-filter="convert">è½¬æ¢</div>
  </div>

  <!-- ç»Ÿè®¡æ  -->
  <div class="stats-bar" id="statsBar">
    <div class="stat-item">
      <div class="stat-label">æ€»äº¤æ˜“</div>
      <div class="stat-value" id="totalCount">0</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">ä¹°å…¥é‡‘é¢</div>
      <div class="stat-value" id="buyAmount">Â¥0</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">å–å‡ºé‡‘é¢</div>
      <div class="stat-value" id="sellAmount">Â¥0</div>
    </div>
  </div>

  <!-- äº¤æ˜“åˆ—è¡¨ -->
  <main style="padding-bottom: 80px;">
    <div class="transaction-list" id="transactionList">
      <!-- äº¤æ˜“åˆ—è¡¨å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
    </div>

    <!-- ç©ºçŠ¶æ€ -->
    <div class="empty-state hidden" id="emptyState">
      <div class="empty-state-icon">ğŸ“</div>
      <div class="empty-state-text">æš‚æ— äº¤æ˜“è®°å½•</div>
    </div>
  </main>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <nav class="bottom-nav">
    <a href="index.html" class="bottom-nav-item">
      <span class="bottom-nav-item-icon">ğŸ“Š</span>
      <span>æŒä»“</span>
    </a>
    <a href="transactions.html" class="bottom-nav-item active">
      <span class="bottom-nav-item-icon">ğŸ“</span>
      <span>äº¤æ˜“</span>
    </a>
    <a href="settings.html" class="bottom-nav-item">
      <span class="bottom-nav-item-icon">âš™ï¸</span>
      <span>è®¾ç½®</span>
    </a>
  </nav>

  <!-- JavaScript -->
  <script src="js/storage.js"></script>
  <script src="js/fund-api.js"></script>
  <script src="js/calculator.js"></script>
  <script src="js/utils.js"></script>
  <script>
    // å½“å‰ç­›é€‰
    let currentFilter = 'all';
    let transactions = [];

    /**
     * åˆå§‹åŒ–é¡µé¢
     */
    function initPage() {
      loadTransactions();
      bindEvents();
    }

    /**
     * åŠ è½½äº¤æ˜“è®°å½•
     */
    function loadTransactions() {
      transactions = Storage.getTransactions();
      renderTransactions();
      updateStats();
    }

    /**
     * æ¸²æŸ“äº¤æ˜“è®°å½•
     */
    function renderTransactions() {
      const listEl = document.getElementById('transactionList');
      const emptyEl = document.getElementById('emptyState');

      // ç­›é€‰
      let filtered = transactions;
      if (currentFilter !== 'all') {
        filtered = transactions.filter(t => t.type === currentFilter);
      }

      if (filtered.length === 0) {
        listEl.innerHTML = '';
        emptyEl.classList.remove('hidden');
        return;
      }

      emptyEl.classList.add('hidden');

      // æŒ‰æ—¥æœŸåˆ†ç»„
      const grouped = groupByDate(filtered);

      let html = '';
      for (const date in grouped) {
        html += `
          <div class="date-group">
            <div class="date-header">${formatDateHeader(date)}</div>
        `;

        grouped[date].forEach(t => {
          const typeName = Utils.getTransactionTypeName(t.type);
          html += `
            <div class="transaction-item" onclick="viewTransaction('${t.id}')">
              <div class="transaction-header">
                <div class="transaction-fund">${escapeHtml(t.fundName)}</div>
                <span class="transaction-type-badge ${t.type}">${typeName}</span>
              </div>
              <div class="transaction-details">
                <div class="transaction-shares">${t.shares.toFixed(2)} ä»½ @ Â¥${t.price.toFixed(4)}</div>
                <div class="transaction-amount">Â¥${t.amount.toFixed(2)}</div>
              </div>
              <div class="transaction-date">${t.date}</div>
            </div>
          `;
        });

        html += '</div>';
      }

      listEl.innerHTML = html;
    }

    /**
     * æŒ‰æ—¥æœŸåˆ†ç»„
     */
    function groupByDate(items) {
      const grouped = {};
      items.forEach(item => {
        if (!grouped[item.date]) {
          grouped[item.date] = [];
        }
        grouped[item.date].push(item);
      });
      return grouped;
    }

    /**
     * æ ¼å¼åŒ–æ—¥æœŸæ ‡é¢˜
     */
    function formatDateHeader(date) {
      const today = new Date().toISOString().split('T')[0];
      const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];

      if (date === today) {
        return 'ä»Šå¤©';
      } else if (date === yesterday) {
        return 'æ˜¨å¤©';
      } else {
        return date;
      }
    }

    /**
     * æ›´æ–°ç»Ÿè®¡
     */
    function updateStats() {
      document.getElementById('totalCount').textContent = transactions.length;

      let buyAmount = 0;
      let sellAmount = 0;

      transactions.forEach(t => {
        if (t.type === 'buy') {
          buyAmount += t.amount;
        } else if (t.type === 'sell') {
          sellAmount += t.amount;
        }
      });

      document.getElementById('buyAmount').textContent = formatAmount(buyAmount);
      document.getElementById('sellAmount').textContent = formatAmount(sellAmount);
    }

    /**
     * æ ¼å¼åŒ–é‡‘é¢
     */
    function formatAmount(amount) {
      if (amount >= 10000) {
        return (amount / 10000).toFixed(1) + 'ä¸‡';
      }
      return amount.toFixed(0);
    }

    /**
     * æŸ¥çœ‹äº¤æ˜“è¯¦æƒ…
     */
    function viewTransaction(id) {
      // å¯ä»¥æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
      const transaction = transactions.find(t => t.id === id);
      if (transaction) {
        const typeName = Utils.getTransactionTypeName(transaction.type);
        const message = `
          ${transaction.fundName} (${transaction.fundCode})
          ${typeName} ${transaction.shares.toFixed(2)} ä»½
          @ Â¥${transaction.price.toFixed(4)}
          é‡‘é¢: Â¥${transaction.amount.toFixed(2)}
          æ—¥æœŸ: ${transaction.date}
        `;
        alert(message.trim());
      }
    }

    /**
     * å¯¼å‡ºäº¤æ˜“è®°å½•
     */
    function exportTransactions() {
      if (transactions.length === 0) {
        Utils.toast('æš‚æ— äº¤æ˜“è®°å½•');
        return;
      }

      // ç”Ÿæˆ CSV æ ¼å¼
      let csv = 'æ—¥æœŸ,åŸºé‡‘ä»£ç ,åŸºé‡‘åç§°,ç±»å‹,ä»½é¢,å‡€å€¼,é‡‘é¢\n';
      transactions.forEach(t => {
        const typeName = Utils.getTransactionTypeName(t.type);
        csv += `${t.date},${t.fundCode},${t.fundName},${typeName},${t.shares.toFixed(2)},${t.price.toFixed(4)},${t.amount.toFixed(2)}\n`;
      });

      const filename = `åŸºé‡‘äº¤æ˜“è®°å½•_${new Date().toISOString().split('T')[0]}.csv`;
      Utils.downloadFile(csv, filename, 'text/csv;charset=utf-8;');
    }

    /**
     * HTML è½¬ä¹‰
     */
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * ç»‘å®šäº‹ä»¶
     */
    function bindEvents() {
      // ç­›é€‰æ ‡ç­¾
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentFilter = tab.dataset.filter;
          renderTransactions();
        });
      });

      // å¯¼å‡ºæŒ‰é’®
      document.getElementById('exportBtn').addEventListener('click', exportTransactions);
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>
